#!/bin/bash
# Pre-commit hook que ejecuta las verificaciones de calidad

echo "ğŸ” Ejecutando verificaciones pre-commit..."

# Cambiar al directorio del proyecto
cd "$(git rev-parse --show-toplevel)"

# Verificar que Docker estÃ© funcionando
if ! docker compose ps | grep -q "Up"; then
    echo "âŒ Docker compose no estÃ¡ ejecutÃ¡ndose. Ejecuta: make up"
    exit 1
fi

# Ejecutar verificaciones
echo "ğŸ“ Verificando formato de cÃ³digo..."
if ! make cs-check > /dev/null 2>&1; then
    echo "âŒ Errores de formato encontrados. Ejecutando correcciÃ³n automÃ¡tica..."
    make cs-fix
    echo "âœ… Formato corregido. Por favor, haz add y commit nuevamente."
    exit 1
fi

echo "ğŸ”¬ Ejecutando anÃ¡lisis estÃ¡tico..."
if ! make phpstan > /dev/null 2>&1; then
    echo "âŒ Errores en anÃ¡lisis estÃ¡tico. Revisa los errores:"
    make phpstan
    exit 1
fi

echo "ğŸ§ª Ejecutando tests..."
if ! make test > /dev/null 2>&1; then
    echo "âŒ Tests fallando. Revisa los errores:"
    make test
    exit 1
fi

echo "âœ… Todas las verificaciones pasaron correctamente!"
exit 0
